<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Nobar Universal</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body{margin:0;background:#0f0e17;color:#fff;font-family:sans-serif}
.top{padding:10px;display:flex;gap:10px}
input{flex:1;padding:10px;border-radius:8px;border:none}
button{padding:10px 20px;border:none;border-radius:8px;background:#ff8906;color:#000}
#player{width:100%;height:60vh;background:#000}
.user{font-size:13px}
.watching{color:#2cb67d}
.idle{color:#ff8906}
.away{color:#e53170}
</style>
</head>
<body>

<div class="top">
  <input id="name" placeholder="Nama">
  <button onclick="join()">Join</button>
</div>

<div class="top">
  <input id="src" placeholder="Paste link video apa aja">
  <button onclick="loadSrc()">Putar</button>
</div>

<div id="player"></div>

<h3>User</h3>
<div id="users"></div>

<script>
const socket = io();
let syncing = false;
let lastAction = 0;

function join(){
  socket.emit("join", document.getElementById("name").value);
}

function normalize(url){
  // YouTube
  if(url.includes("youtube.com") || url.includes("youtu.be")){
    let id = url.includes("youtu.be/")
      ? url.split("youtu.be/")[1].split("?")[0]
      : url.split("v=")[1].split("&")[0];
    return `https://www.youtube-nocookie.com/embed/${id}?autoplay=1`;
  }
  return url;
}

function loadSrc(){
  const src = normalize(document.getElementById("src").value);
  socket.emit("video-action",{src,playing:true,time:0});
}

socket.on("init-state", s => {
  if(s.src) applySync(s);
});

socket.on("sync", s => applySync(s));

function applySync(s){
  syncing = true;
  const box = document.getElementById("player");

  box.innerHTML = `
    <iframe src="${s.src}" 
      allow="autoplay; fullscreen" 
      style="width:100%;height:100%;border:none">
    </iframe>
  `;

  socket.emit("user-status", s.playing ? "watching" : "idle");
  setTimeout(()=>syncing=false,800);
}

document.addEventListener("visibilitychange",()=>{
  socket.emit("user-status", document.hidden ? "away":"watching");
});

socket.on("users", u=>{
  document.getElementById("users").innerHTML =
    Object.values(u).map(x=>{
      return `<div class="user ${x.status}">‚óè ${x.name} (${x.status})</div>`;
    }).join("");
});
</script>
</body>
</html>