<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Party - Simple & Proper</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f0e17; --headline: #fffffe; --paragraph: #a7a9be; --button: #ff8906; --tertiary: #e53170; --card: #16161a; }
        
        body { background: var(--bg); color: var(--paragraph); font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; height: 100vh; overflow: hidden; }
        .container { display: flex; height: 100vh; width: 100vw; }

        /* Video Area */
        .main-content { flex: 3; display: flex; flex-direction: column; padding: 20px; background: #000; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { background: var(--card); border: 2px solid #242629; padding: 12px; border-radius: 10px; color: #fff; flex: 1; outline: none; }
        button { background: var(--tertiary); color: #fff; border: none; padding: 0 25px; border-radius: 10px; cursor: pointer; font-weight: 800; transition: 0.2s; }
        button:hover { filter: brightness(1.2); transform: translateY(-1px); }

        .video-box { flex: 1; display: flex; align-items: center; justify-content: center; background: #000; border-radius: 15px; overflow: hidden; position: relative; }
        
        /* Fix Video Size - Proper & Big */
        .plyr { width: 100% !important; height: 100% !important; max-width: none !important; }
        .plyr__video-wrapper { height: 100% !important; }

        /* Sidebar Area */
        .sidebar { flex: 1; background: var(--card); border-left: 1px solid #242629; display: flex; flex-direction: column; padding: 20px; min-width: 320px; }
        #chat-box { flex: 1; overflow-y: auto; background: #0f0e17; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #242629; }
        .user-list { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; }
        .badge { background: #242629; padding: 5px 12px; border-radius: 8px; font-size: 12px; border: 1px solid #333; }
        
        #login { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: var(--card); padding: 40px; border-radius: 20px; text-align: center; border: 1px solid #242629; width: 300px; }
    </style>
</head>
<body>

<div id="login">
    <div class="login-box">
        <h2 style="color:white; margin-top:0;">Watch Party</h2>
        <input type="text" id="userName" placeholder="Nama kamu..." style="width:100%; margin-bottom:20px; box-sizing:border-box;">
        <button onclick="startApp()" style="width:100%; height:45px;">Masuk</button>
    </div>
</div>

<div class="container">
    <div class="main-content">
        <div class="input-group">
            <input type="text" id="videoUrl" placeholder="Link YouTube atau MP4...">
            <button onclick="loadNewVideo()">Ganti Video</button>
        </div>
        <div class="video-box">
            <div id="player" data-plyr-provider="youtube" data-plyr-embed-id="aqz-KE-bpKQ"></div>
        </div>
    </div>

    <div class="sidebar">
        <div style="font-size:11px; font-weight:800; margin-bottom:10px; color:var(--tertiary)">PENONTON</div>
        <div id="user-list" class="user-list"></div>
        <div id="chat-box"></div>
        <div class="input-group">
            <input type="text" id="chatMsg" placeholder="Ketik pesan..." onkeypress="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()">Kirim</button>
        </div>
    </div>
</div>

<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script>
    const socket = io();
    let player = new Plyr('#player', { ratio: '16:9' });
    let isRemote = false;

    function startApp() {
        const name = document.getElementById('userName').value;
        if(name) {
            document.getElementById('login').style.display = 'none';
            socket.emit('join-room', name);
        }
    }

    // Fungsi muat video baru
    function loadNewVideo(url, remote = false) {
        const src = url || document.getElementById('videoUrl').value;
        if(!src) return;

        const yt = src.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/);
        if(yt) {
            player.source = { type: 'video', sources: [{ src: yt[7], provider: 'youtube' }] };
        } else {
            player.source = { type: 'video', sources: [{ src: src, type: 'video/mp4' }] };
        }

        if(!remote) socket.emit('video-action', { type: 'load', url: src });
    }

    // Menerima aksi dari orang lain
    socket.on('video-action', (data) => {
        isRemote = true; // Kunci supaya tidak kirim balik (loop)
        
        if(data.type === 'load') loadNewVideo(data.url, true);
        
        if(data.type === 'play') {
            player.currentTime = data.time;
            player.play();
        }
        
        if(data.type === 'pause') {
            player.pause();
            player.currentTime = data.time;
        }

        if(data.type === 'seek') player.currentTime = data.time;

        setTimeout(() => { isRemote = false; }, 800);
    });

    // Mengirim aksi ke orang lain
    player.on('play', () => {
        if(!isRemote) socket.emit('video-action', { type: 'play', time: player.currentTime });
    });

    player.on('pause', () => {
        if(!isRemote) socket.emit('video-action', { type: 'pause', time: player.currentTime });
    });

    player.on('seeked', () => {
        if(!isRemote) socket.emit('video-action', { type: 'seek', time: player.currentTime });
    });

    // Chat & User List
    socket.on('update-users', (list) => {
        document.getElementById('user-list').innerHTML = list.map(u => `<span class="badge">${u}</span>`).join('');
    });

    socket.on('chat-receive', (data) => {
        const cb = document.getElementById('chat-box');
        cb.innerHTML += `<div><b style="color:var(--tertiary)">${data.user}:</b> ${data.msg}</div>`;
        cb.scrollTop = cb.scrollHeight;
    });

    function sendChat() {
        const input = document.getElementById('chatMsg');
        if(!input.value) return;
        const myName = document.getElementById('userName').value;
        socket.emit('new-message', { user: myName, msg: input.value });
        document.getElementById('chat-box').innerHTML += `<div><b style="color:var(--paragraph)">Kamu:</b> ${input.value}</div>`;
        input.value = "";
        document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
    }
</script>
</body>
</html>
