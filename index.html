<!DOCTYPE html>
<html>
<head>
  <title>Nobar Realtime</title>
  <style>
    body {
      background:#0f172a;
      color:white;
      font-family:Arial;
      padding:20px;
    }
    input, button {
      padding:8px;
      width:420px;
      max-width:100%;
      margin:5px 0;
    }
    video { max-width:100%; margin-top:15px }
  </style>
</head>
<body>

<h2>ðŸŽ¬ Nobar Realtime (Clock Sync)</h2>

<input id="url" placeholder="Paste video URL">
<button onclick="loadVideo()">Load</button>
<button onclick="play()">Play</button>
<button onclick="pause()">Pause</button>

<video id="video" controls></video>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const video = document.getElementById("video");

let state = null;
let syncTimer = null;

/* ===== HOST CONTROL (BISA KAMU KUNCI NANTI) ===== */
function loadVideo() {
  socket.emit("load-video", url.value);
}
function play() {
  socket.emit("play");
}
function pause() {
  socket.emit("pause");
}

/* ===== APPLY STATE ===== */
socket.on("state", s => {
  state = s;
  if (!state.video) return;

  if (video.src !== state.video) {
    video.src = state.video;
  }

  clearInterval(syncTimer);

  if (state.startedAt) {
    syncTimer = setInterval(syncPlayback, 500);
  }
});

/* ===== CORE SYNC LOGIC ===== */
function syncPlayback() {
  const now = Date.now();
  let targetTime = (now - state.startedAt) / 1000;

  const diff = targetTime - video.currentTime;

  if (Math.abs(diff) > 0.5) {
    video.currentTime = targetTime;
  }

  if (video.paused) {
    video.play().catch(()=>{});
  }
}
</script>

</body>
</html>