<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer" />
    <title>Watch Party Simple Fix</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root { --bg: #0f0e17; --tertiary: #e53170; }
        body { background: var(--bg); color: white; font-family: sans-serif; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        .nav { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #000; color: white; }
        button { padding: 10px 20px; border-radius: 8px; border: none; background: var(--tertiary); color: white; font-weight: bold; cursor: pointer; }
        .video-box { background: #000; border-radius: 15px; overflow: hidden; min-height: 400px; border: 1px solid #242629; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav">
        <input type="text" id="urlInput" placeholder="Masukkan Link YouTube atau .m3u8">
        <button id="btnPutar">PUTAR</button>
    </div>
    
    <div class="video-box">
        <video id="player" playsinline controls></video>
    </div>
</div>

<script>
    const socket = io();
    const video = document.getElementById('player');
    const input = document.getElementById('urlInput');
    const btn = document.getElementById('btnPutar');
    
    // Inisialisasi Player
    const player = new Plyr('#player', {
        controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen']
    });

    let hls = new Hls();
    let isSyncing = false;

    // FUNGSI UTAMA LOAD VIDEO
    function loadNewVideo(url, type) {
        isSyncing = true;
        
        if (url.includes('youtube.com') || url.includes('youtu.be')) {
            // Jika YouTube
            player.source = {
                type: 'video',
                sources: [{ src: url, provider: 'youtube' }]
            };
        } else if (url.includes('.m3u8')) {
            // Jika HLS / m3u8
            if (Hls.isSupported()) {
                hls.destroy();
                hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
            } else {
                video.src = url;
            }
        } else {
            // Jika MP4 biasa
            video.src = url;
        }

        setTimeout(() => { isSyncing = false; }, 2000);
    }

    // Klik Tombol Putar
    btn.addEventListener('click', () => {
        const url = input.value;
        if(!url) return;
        
        loadNewVideo(url);
        socket.emit('video-control', { action: 'load', url: url });
    });

    // Kontrol Play/Pause
    player.on('play', () => {
        if(!isSyncing) socket.emit('video-control', { action: 'play', time: player.currentTime });
    });

    player.on('pause', () => {
        if(!isSyncing) socket.emit('video-control', { action: 'pause', time: player.currentTime });
    });

    // Terima Sinyal dari Orang Lain
    socket.on('video-control', (data) => {
        isSyncing = true;
        if (data.action === 'load') {
            loadNewVideo(data.url);
        } else if (data.action === 'play') {
            player.currentTime = data.time;
            player.play();
        } else if (data.action === 'pause') {
            player.pause();
        }
        setTimeout(() => { isSyncing = false; }, 1000);
    });
</script>
</body>
</html>
