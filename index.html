<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nobar</title>
<script src="/socket.io/socket.io.js"></script>

<style>
:root{
  --bg:#0f172a;
  --card:#111827;
  --primary:#6366f1;
  --accent:#22c55e;
  --warn:#f59e0b;
  --danger:#ef4444;
  --text:#e5e7eb;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,sans-serif;
}
.app{
  display:grid;
  grid-template-columns:1fr 320px;
  height:100vh;
}
@media(max-width:900px){
  .app{grid-template-columns:1fr}
  .side{height:45vh}
}
.top{
  padding:12px;
  display:flex;
  gap:10px;
  background:var(--card);
}
input,button{
  border-radius:10px;
  border:none;
  padding:12px;
}
input{flex:1}
button{
  background:var(--primary);
  color:#fff;
  font-weight:600;
}
#player{
  height:55vh;
  background:black;
}
.side{
  display:flex;
  flex-direction:column;
  background:var(--card);
}
.users,.chat{
  padding:12px;
  overflow:auto;
}
.user{
  font-size:13px;
  margin-bottom:6px;
}
.watching{color:var(--accent)}
.idle{color:var(--warn)}
.away{color:var(--danger)}
.chat-msg{
  font-size:13px;
  margin-bottom:6px;
}
.chat-input{
  display:flex;
  gap:8px;
  padding:10px;
}
.voice{
  background:var(--accent);
  color:#000;
}
</style>
</head>

<body>
<div class="top">
  <input id="name" placeholder="Nama">
  <button onclick="join()">Join</button>
</div>

<div class="top">
  <input id="src" placeholder="Paste link video apa aja">
  <button onclick="play()">Putar</button>
</div>

<div class="app">
  <div>
    <div id="player"></div>
  </div>

  <div class="side">
    <div class="users" id="users"></div>
    <div class="chat" id="chat"></div>
    <div class="chat-input">
      <input id="msg" placeholder="Chat‚Ä¶">
      <button onclick="sendChat()">‚û§</button>
      <button class="voice" onmousedown="startVoice()" onmouseup="stopVoice()">üé§</button>
    </div>
  </div>
</div>

<script>
const socket = io();
let myName = "";
let recorder, stream;

function join(){
  myName = name.value;
  socket.emit("join", myName);
}

function normalize(url){
  if(url.includes("youtube")){
    let id = url.includes("youtu.be")
      ? url.split("youtu.be/")[1].split("?")[0]
      : url.split("v=")[1].split("&")[0];
    return `https://www.youtube-nocookie.com/embed/${id}?autoplay=1`;
  }
  return url;
}

function play(){
  const src = normalize(document.getElementById("src").value);
  socket.emit("video-action",{src,playing:true,time:0});
}

socket.on("init-state", s => s.src && sync(s));
socket.on("sync", s => sync(s));

function sync(s){
  player.innerHTML = `
    <iframe src="${s.src}"
      allow="autoplay; fullscreen"
      style="width:100%;height:100%;border:none"></iframe>`;
  socket.emit("user-status", s.playing ? "watching":"idle");
}

document.addEventListener("visibilitychange",()=>{
  socket.emit("user-status", document.hidden?"away":"watching");
});

socket.on("users", u=>{
  users.innerHTML = Object.values(u).map(x=>
    `<div class="user ${x.status}">‚óè ${x.name}</div>`
  ).join("");
});

/* CHAT */
function sendChat(){
  if(!msg.value) return;
  chat.innerHTML += `<div class="chat-msg"><b>kamu:</b> ${msg.value}</div>`;
  socket.emit("chat",{user:myName,msg:msg.value});
  msg.value="";
}
socket.on("chat",d=>{
  chat.innerHTML += `<div class="chat-msg"><b>${d.user}:</b> ${d.msg}</div>`;
});

/* VOICE NOTE (push to talk) */
async function startVoice(){
  stream = await navigator.mediaDevices.getUserMedia({audio:true});
  recorder = new MediaRecorder(stream);
  let chunks=[];
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=()=>{
    const blob = new Blob(chunks,{type:"audio/webm"});
    blob.arrayBuffer().then(b=>{
      socket.emit("voice",b);
    });
  };
  recorder.start();
}
function stopVoice(){
  recorder && recorder.stop();
  stream && stream.getTracks().forEach(t=>t.stop());
}
socket.on("voice",data=>{
  const audio = new Audio(URL.createObjectURL(new Blob([data])));
  audio.play();
});
</script>
</body>
</html>