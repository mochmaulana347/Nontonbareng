<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Party - Ultra Stable</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; padding: 20px; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #111; color: #fff; }
        button { padding: 10px 20px; background: #3b82f6; border: none; color: #fff; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #player-box { width: 100%; max-width: 900px; margin: 0 auto; border-radius: 12px; overflow: hidden; border: 1px solid #222; }
    </style>
</head>
<body>

<div class="controls">
    <input type="text" id="urlInput" placeholder="Link Video (Direct/YouTube/M3U8)...">
    <button onclick="changeSource()">Muat Video</button>
</div>

<div id="player-box">
    <video id="player" playsinline controls></video>
</div>

<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script>
    const socket = io();
    const v = document.getElementById('player');
    const player = new Plyr(v, { ratio: '16:9' });

    let lockSync = false; // KUNCI UTAMA: Biar gak ngeloop
    let lastActionId = null;

    function changeSource(url, fromRemote = false) {
        const src = url || document.getElementById('urlInput').value;
        if (!src) return;

        if (src.includes('.m3u8')) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(src);
                hls.attachMedia(v);
            } else { v.src = src; }
        } else {
            player.source = { type: 'video', sources: [{ src: src }] };
        }

        if (!fromRemote) {
            sendAction('change', src, 0);
        }
    }

    // Fungsi Pengirim Universal
    function sendAction(type, url = null, time = null) {
        if (lockSync) return; // Jangan lapor kalau sedang menerima perintah

        const actionId = Math.random().toString(36).substring(7);
        lastActionId = actionId;

        socket.emit('video-action', {
            id: actionId,
            action: type,
            url: url || document.getElementById('urlInput').value,
            time: time !== null ? time : player.currentTime
        });
    }

    // Event Listeners
    player.on('play', () => sendAction('play'));
    player.on('pause', () => sendAction('pause'));
    player.on('seeked', () => sendAction('seek'));

    // MENERIMA PERINTAH (Anti-Loop Logic)
    socket.on('video-action', (data) => {
        if (data.id === lastActionId) return; // Abaikan perintah buatan sendiri

        lockSync = true; // AKTIFKAN KUNCI

        if (data.action === 'change') changeSource(data.url, true);
        
        // Eksekusi Sinkronisasi
        setTimeout(() => {
            const diff = Math.abs(player.currentTime - data.time);
            
            // Hanya lompat durasi jika selisih > 3 detik (Mencegah Stuttering)
            if (data.time !== undefined && diff > 3) {
                player.currentTime = data.time;
            }

            if (data.action === 'play') player.play();
            if (data.action === 'pause') player.pause();

            // Buka kunci setelah 1 detik stabil
            setTimeout(() => { lockSync = false; }, 1000);
        }, 500);
    });

    // Sinkronisasi awal saat baru buka web
    socket.on('sync-all', (data) => {
        if (data.url) {
            changeSource(data.url, true);
            setTimeout(() => {
                player.currentTime = data.time;
                if (data.playing) player.play();
            }, 2000);
        }
    });

</script>
</body>
</html>
