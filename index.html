<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Party Stable</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body {
  margin: 0;
  background: #000;
  color: #fff;
  font-family: Arial, sans-serif;
}
#top {
  padding: 10px;
  display: flex;
  gap: 10px;
  background: #111;
}
input, button {
  padding: 10px;
  font-size: 14px;
}
#player {
  width: 100vw;
  height: calc(100vh - 60px);
}
</style>
</head>
<body>

<div id="top">
  <input id="vid" placeholder="YouTube Video ID">
  <button onclick="start()">START NOBAR</button>
  <button onclick="userPlay()">▶ PLAY</button>
</div>

<div id="player"></div>

<script>
const socket = io();
let player;
let userAllowedPlay = false;

// load youtube api
const tag = document.createElement("script");
tag.src = "https://www.youtube.com/iframe_api";
document.body.appendChild(tag);

function onYouTubeIframeAPIReady() {
  player = new YT.Player("player", {
    videoId: "dQw4w9WgXcQ",
    playerVars: { rel: 0 },
  });
}

// user gesture play
function userPlay() {
  userAllowedPlay = true;
  player.playVideo().catch(()=>{});
}

// host mulai nobar
function start() {
  const vid = document.getElementById("vid").value;
  if (!vid) return;

  player.loadVideoById(vid, 0);
  socket.emit("start-video", { vid, time: 0 });
}

// sync logic (TIME ONLY)
socket.on("video-sync", (state) => {
  if (!player || !state.startedAt) return;

  const currentVid = player.getVideoData().video_id;
  if (state.vid !== currentVid) {
    player.loadVideoById(state.vid, 0);
    return;
  }

  const targetTime = (Date.now() - state.startedAt) / 1000;
  const diff = targetTime - player.getCurrentTime();

  if (Math.abs(diff) > 1) {
    player.seekTo(targetTime, true);
  }

  // ❌ JANGAN AUTO PLAY
});
</script>

</body>
</html>