<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Party - Ultra Sync</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f0e17; --headline: #fffffe; --paragraph: #a7a9be; --button: #ff8906; --tertiary: #e53170; --card-bg: #16161a; }
        body { background: var(--bg); color: var(--paragraph); font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; overflow: hidden; height: 100vh; }
        .app-container { display: flex; height: 100vh; width: 100vw; }
        .video-section { flex: 3; display: flex; flex-direction: column; padding: 20px; background: #000; }
        .nav-input { display: flex; gap: 12px; margin-bottom: 20px; z-index: 10; }
        input { background: var(--card-bg); border: 2px solid #242629; padding: 14px; border-radius: 12px; color: #fff; outline: none; flex: 1; }
        button { background: var(--tertiary); color: #fff; border: none; padding: 0 25px; border-radius: 12px; cursor: pointer; font-weight: 800; transition: 0.3s; }
        .video-wrapper { flex: 1; position: relative; background: #000; border-radius: 20px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .plyr { width: 100% !important; height: 100% !important; }
        .sidebar { flex: 1; background: var(--card-bg); border-left: 1px solid #242629; display: flex; flex-direction: column; padding: 25px; min-width: 350px; }
        #chat-box { flex: 1; overflow-y: auto; background: #0f0e17; border-radius: 15px; padding: 20px; border: 1px solid #242629; margin-bottom: 20px; }
        #sync-overlay { position: absolute; inset: 0; background: rgba(15, 14, 23, 0.95); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        #login-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 200; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div style="background: var(--card-bg); padding: 50px; border-radius: 30px; text-align: center;">
        <h2 style="color:white">Watch Party</h2>
        <input type="text" id="nameInput" placeholder="Nama..." style="width:100%; margin-bottom:20px;">
        <button onclick="join()" style="width:100%; height:50px;">Masuk</button>
    </div>
</div>

<div class="app-container">
    <div class="video-section">
        <div class="nav-input">
            <input type="text" id="urlInput" placeholder="Link YouTube/MP4...">
            <button onclick="changeVideo()">Ganti</button>
        </div>
        <div class="video-wrapper">
            <div id="sync-overlay">
                <h2 style="color:white">Sinkronisasi Diperlukan</h2>
                <button onclick="startSync()" style="background:var(--button); padding:20px 50px; border-radius: 50px;">KLIK UNTUK SINKRON</button>
            </div>
            <div id="player" data-plyr-provider="youtube" data-plyr-embed-id="aqz-KE-bpKQ"></div>
        </div>
    </div>
    <div class="sidebar">
        <h4>Penonton</h4>
        <div id="user-list" style="display:flex; gap:5px; margin-bottom:20px;"></div>
        <h4>Chat</h4>
        <div id="chat-box"></div>
        <div class="nav-input">
            <input type="text" id="chatInput" placeholder="Pesan..." onkeypress="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()">Kirim</button>
        </div>
    </div>
</div>

<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script>
    const socket = io();
    let player = new Plyr('#player', { ratio: '16:9' });
    let isLock = false;
    let masterTime = 0;

    function join() {
        const n = document.getElementById('nameInput').value;
        if(n) { document.getElementById('login-overlay').style.display='none'; socket.emit('join-room', n); }
    }

    function startSync() {
        document.getElementById('sync-overlay').style.display = 'none';
        player.play().then(() => {
            player.currentTime = masterTime;
        });
    }

    socket.on('video-command', (data) => {
        if(data.action === 'initial-sync') {
            masterTime = data.time;
            document.getElementById('sync-overlay').style.display = 'flex';
        } else {
            handleCommand(data);
        }
    });

    function handleCommand(data) {
        isLock = true;
        if(data.action === 'change') {
            const ytMatch = data.url.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/);
            if(ytMatch) player.source = { type: 'video', sources: [{ src: ytMatch[7], provider: 'youtube' }] };
            else player.source = { type: 'video', sources: [{ src: data.url, type: 'video/mp4' }] };
        }

        setTimeout(() => {
            const diff = Math.abs(player.currentTime - data.time);
            // Paksa lompat jika selisih > 2 detik
            if (diff > 2) player.currentTime = data.time;
            
            if(data.playing) player.play().catch(() => {});
            else player.pause();
            
            setTimeout(() => isLock = false, 1000);
        }, 1000);
    }

    function changeVideo() {
        const url = document.getElementById('urlInput').value;
        if(!url) return;
        socket.emit('video-command', { action: 'change', url: url, time: 0, playing: true });
    }

    // Lapor aksi fisik
    player.on('play', () => { if(!isLock) socket.emit('video-command', { action: 'play', time: player.currentTime, playing: true }); });
    player.on('pause', () => { if(!isLock) socket.emit('video-command', { action: 'pause', time: player.currentTime, playing: false }); });
    player.on('seeked', () => { if(!isLock) socket.emit('video-command', { action: 'seek', time: player.currentTime, playing: !player.paused }); });

    // Update list user & chat (UI Only)
    socket.on('update-users', (u) => { document.getElementById('user-list').innerHTML = u.map(i => `<small style="background:#333;padding:5px;border-radius:5px">${i.name}</small>`).join(''); });
    socket.on('chat-receive', (d) => { document.getElementById('chat-box').innerHTML += `<div style="margin-bottom:10px"><b>${d.user}:</b> ${d.msg}</div>`; });
    function sendChat() { 
        const i = document.getElementById('chatInput'); 
        socket.emit('new-message', i.value); 
        document.getElementById('chat-box').innerHTML += `<div><b>Kamu:</b> ${i.value}</div>`; 
        i.value = ""; 
    }
</script>
</body>
</html>
