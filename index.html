<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nobar</title>
<script src="/socket.io/socket.io.js"></script>

<style>
:root{
  --bg:#0f172a; --card:#111827; --primary:#6366f1;
  --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444;
}
body{margin:0;background:var(--bg);color:#e5e7eb;font-family:sans-serif}
.top{padding:12px;display:flex;gap:8px;background:var(--card)}
input,button{padding:10px;border-radius:10px;border:none}
button{background:var(--primary);color:white;font-weight:600}
#player{height:55vh;background:black}
.side{background:var(--card);height:45vh;display:flex;flex-direction:column}
.users,.chat{padding:10px;overflow:auto}
.chat-input{display:flex;gap:6px;padding:10px}
.user.watching{color:var(--accent)}
.user.idle{color:var(--warn)}
.user.away{color:var(--danger)}
</style>
</head>

<body>

<!-- LOGIN SEKALI -->
<div id="login" style="position:fixed;inset:0;background:#000c;display:flex;align-items:center;justify-content:center">
  <div style="background:var(--card);padding:20px;border-radius:16px">
    <input id="name" placeholder="Nickname">
    <button onclick="start()">Masuk</button>
  </div>
</div>

<div class="top">
  <input id="src" placeholder="Paste link video apa aja">
  <button onclick="play()">Putar</button>
</div>

<div id="player"></div>

<div class="side">
  <div class="users" id="users"></div>
  <div class="chat" id="chat"></div>
  <div class="chat-input">
    <input id="msg" placeholder="Chat">
    <button onclick="sendChat()">‚û§</button>
    <button onmousedown="rec()" onmouseup="stop()">üé§</button>
  </div>
</div>

<script>
const socket = io();
let myName="", recorder, chunks=[];

/* JOIN SEKALI */
function start(){
  myName = name.value;
  socket.emit("join", myName);
  login.style.display="none";
}

/* VIDEO */
function normalize(u){
  if(u.includes("youtube")){
    let id=u.includes("youtu.be")
      ?u.split("youtu.be/")[1].split("?")[0]
      :u.split("v=")[1].split("&")[0];
    return `https://www.youtube-nocookie.com/embed/${id}?autoplay=1`;
  }
  return u;
}
function play(){
  socket.emit("video-action",{src:normalize(src.value),playing:true});
}
socket.on("init-state",s=>s.src&&sync(s));
socket.on("sync",sync);

function sync(s){
  player.innerHTML=`<iframe src="${s.src}" allow="autoplay;fullscreen"
    style="width:100%;height:100%;border:none"></iframe>`;
  socket.emit("user-status",s.playing?"watching":"idle");
}

/* USERS */
document.addEventListener("visibilitychange",()=>{
  socket.emit("user-status",document.hidden?"away":"watching");
});
socket.on("users",u=>{
  users.innerHTML=Object.values(u).map(x=>
    `<div class="user ${x.status}">‚óè ${x.name}</div>`
  ).join("");
});

/* CHAT */
function sendChat(){
  if(!msg.value)return;
  chat.innerHTML+=`<div><b>kamu:</b> ${msg.value}</div>`;
  socket.emit("chat",{user:myName,msg:msg.value});
  msg.value="";
}
socket.on("chat",d=>{
  chat.innerHTML+=`<div><b>${d.user}:</b> ${d.msg}</div>`;
});

/* VOICE NOTE (FIXED) */
async function rec(){
  chunks=[];
  const stream=await navigator.mediaDevices.getUserMedia({audio:true});
  recorder=new MediaRecorder(stream);
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=()=>{
    const blob=new Blob(chunks,{type:"audio/webm"});
    const reader=new FileReader();
    reader.onload=()=>socket.emit("voice",reader.result);
    reader.readAsDataURL(blob);
  };
  recorder.start();
}
function stop(){recorder&&recorder.stop();}
socket.on("voice",b64=>{
  const audio=new Audio(b64);
  audio.play();
});
</script>
</body>
</html>