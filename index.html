<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Party Final</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://unpkg.com/phosphor-icons@1.4.2/src/css/icons.css" rel="stylesheet">
<style>
:root{
  --bg:#0f172a;
  --card:#111827;
  --primary:#22c55e;
  --accent:#38bdf8;
  --text:#e5e7eb;
  --muted:#94a3b8;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,sans-serif;}
header{padding:16px 20px;background:linear-gradient(90deg,#22c55e,#38bdf8);font-weight:700;color:#022c22;}
main{display:grid;grid-template-columns:3fr 1fr;height:calc(100vh - 60px);}
.video-area{padding:16px}
.controls{display:flex;gap:10px;margin-bottom:12px;}
input{flex:1;padding:12px;border-radius:12px;border:none;outline:none;}
button{padding:12px 16px;border:none;border-radius:12px;background:var(--primary);color:#022c22;font-weight:700;cursor:pointer;}
#player-wrap{width:100%;height:100%;background:black;border-radius:16px;overflow:hidden;}
iframe,video{width:100%;height:100%;border:0;}
aside{background:var(--card);padding:16px;display:flex;flex-direction:column;gap:10px;}
.user{display:flex;align-items:center;gap:8px;padding:8px;background:#020617;border-radius:10px;font-size:13px;}
.green{color:#22c55e}
.gray{color:#64748b}
.login{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,.85);}
.login-card{background:var(--card);padding:30px;border-radius:20px;width:280px;text-align:center;}
#chat-box{flex:1;overflow-y:auto;background:#0f172a;padding:10px;border-radius:12px;margin-top:10px;}
</style>
</head>
<body>

<div class="login" id="login">
  <div class="login-card">
    <h2>Watch Party</h2>
    <input id="nickname" placeholder="Nickname"><br><br>
    <label><input type="checkbox" id="hostCheck"> Host</label><br><br>
    <button onclick="join()">Join</button>
  </div>
</div>

<header>üé¨ Watch Party</header>

<main>
  <div class="video-area">
    <div class="controls">
      <input id="url" placeholder="Paste link video apa aja">
      <button onclick="setVideo()">Putar</button>
      <button onclick="play()">‚ñ∂</button>
      <button onclick="pause()">‚è∏</button>
    </div>
    <div id="player-wrap">
      <iframe id="player" allow="autoplay"></iframe>
    </div>
    <div id="chat-box"></div>
    <div style="display:flex; gap:6px; margin-top:6px;">
      <input id="chatInput" placeholder="Ketik pesan..." onkeypress="if(event.key==='Enter') sendChat()">
      <button onclick="sendChat()">KIRIM</button>
    </div>
  </div>

  <aside>
    <strong>üë• Users</strong>
    <div id="users"></div>
  </aside>
</main>

<script>
const socket = io();
let player = document.getElementById("player");
let isHost = false;

function resolveEmbed(url){
  url = url.trim();
  if(url.includes("youtube.com")||url.includes("youtu.be")){
    let id = url.includes("v=")?url.split("v=")[1].split("&")[0]:url.split("/").pop();
    return { type:"iframe", src:`https://www.youtube.com/embed/${id}?autoplay=1&enablejsapi=1` };
  }
  if(url.includes("vimeo.com")){
    const id = url.split("/").pop();
    return { type:"iframe", src:`https://player.vimeo.com/video/${id}?autoplay=1` };
  }
  if(url.match(/\.(mp4|webm)$/)){
    return { type:"video", src:url };
  }
  return { type:"iframe", src:url };
}

function join(){
  const n = nickname.value.trim();
  if(!n) return;
  isHost = hostCheck.checked;
  socket.emit("join",{name:n,isHost});
  login.style.display="none";
}

function setVideo(){ if(isHost) socket.emit("intent-set-video", url.value); }
function play(){ if(isHost) socket.emit("intent-play"); }
function pause(){ if(isHost) socket.emit("intent-pause"); }

socket.on("sync", state=>{
  if(!state.hostId) return;
  isHost = (socket.id===state.hostId);

  if(state.videoUrl){
    const res = resolveEmbed(state.videoUrl);
    if(res.type==="video"){
      player.outerHTML = `<video id="player" controls autoplay>
        <source src="${res.src}">
      </video>`;
      player = document.getElementById("player");
    }else{
      if(player.tagName!=="IFRAME"){
        document.getElementById("player-wrap").innerHTML =
          `<iframe id="player" allow="autoplay"></iframe>`;
        player = document.getElementById("player");
      }
      if(player.src!==res.src) player.src=res.src;
    }
  }

  if(player.tagName==="IFRAME"){
    try{
      if(state.playing) player.contentWindow?.postMessage('{"event":"command","func":"playVideo"}',"*");
      else player.contentWindow?.postMessage('{"event":"command","func":"pauseVideo"}',"*");
    }catch(e){}
  }else{
    if(state.playing) player.play();
    else player.pause();
  }

  if(isHost && player.tagName==="VIDEO"){
    player.onseeked = ()=> socket.emit("intent-seek", player.currentTime);
  }
});

socket.on("users", users=>{
  const box = document.getElementById("users");
  box.innerHTML="";
  Object.values(users).forEach(u=>{
    const cls = u.status==="watching"?"green":"gray";
    box.innerHTML += `<div class="user"><i class="ph-eye ${cls}"></i>${u.name}</div>`;
  });
});

socket.on("chat-receive", data=>{
  const b=document.getElementById("chat-box");
  b.innerHTML += `<div style="margin-bottom:4px"><b>${data.user}:</b> ${data.msg}</div>`;
  b.scrollTop=b.scrollHeight;
});

function sendChat(){
  const i = document.getElementById("chatInput");
  const n = nickname.value.trim();
  if(!i.value) return;
  socket.emit("new-message",{user:n,msg:i.value});
  const b=document.getElementById("chat-box");
  b.innerHTML += `<div style="margin-bottom:4px;color:#94a3b8"><b>Kamu:</b> ${i.value}</div>`;
  i.value="";
  b.scrollTop=b.scrollHeight;
}

document.addEventListener("visibilitychange",()=>{
  socket.emit("status",document.hidden?"away":"watching");
});
</script>

</body>
</html>