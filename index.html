<!DOCTYPE html>
<html>
<head>
  <title>Nobar (Authoritative)</title>
  <style>
    body {
      background:#0f172a;
      color:white;
      font-family:Arial;
      padding:20px;
    }
    input, button {
      padding:8px;
      width:420px;
      max-width:100%;
      margin:5px 0;
    }
    video { max-width:100%; margin-top:15px }
  </style>
</head>
<body>

<h2>ðŸŽ¬ Nobar (1 Host Control)</h2>
<p id="roleText"></p>

<input id="url" placeholder="Host paste video URL">
<button id="loadBtn" onclick="loadVideo()">Load Video</button>

<div id="player">
  <video id="video" controls style="display:none"></video>
  <div id="yt"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<script>
const socket = io();
const video = document.getElementById("video");
const ytDiv = document.getElementById("yt");
const roleText = document.getElementById("roleText");
const loadBtn = document.getElementById("loadBtn");

let role = "viewer";
let ytPlayer = null;
let applying = false;

/* ===== ROLE ===== */
socket.on("role", r => {
  role = r;
  roleText.innerText = "Role: " + r.toUpperCase();

  if (role !== "host") {
    loadBtn.disabled = true;
    video.controls = false;
  }
});

/* ===== UTIL ===== */
function isYoutube(url) {
  return url.includes("youtube.com") || url.includes("youtu.be");
}
function getYoutubeId(url) {
  const m = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
  return m ? m[1] : null;
}

/* ===== HOST ACTION ===== */
function loadVideo() {
  if (role !== "host") return;
  socket.emit("load-video", url.value);
}

/* ===== APPLY STATE ===== */
function applyState(s) {
  if (!s.video) return;

  applying = true;

  if (isYoutube(s.video)) {
    video.style.display = "none";
    ytDiv.innerHTML = '<div id="ytplayer"></div>';

    ytPlayer = new YT.Player("ytplayer", {
      videoId: getYoutubeId(s.video),
      events: {
        onReady: () => {
          ytPlayer.seekTo(s.time, true);
          if (s.playing) ytPlayer.playVideo();
          else ytPlayer.pauseVideo();
          applying = false;
        },
        onStateChange: e => {
          if (role !== "host" || applying) return;
          if (e.data === 1)
            socket.emit("play", ytPlayer.getCurrentTime());
          if (e.data === 2)
            socket.emit("pause", ytPlayer.getCurrentTime());
        }
      }
    });

  } else {
    ytDiv.innerHTML = "";
    video.style.display = "block";
    video.src = s.video;
    video.currentTime = s.time;
    s.playing ? video.play() : video.pause();
    applying = false;
  }
}

/* ===== HTML5 HOST ONLY ===== */
video.onplay = () => {
  if (role === "host" && !applying)
    socket.emit("play", video.currentTime);
};
video.onpause = () => {
  if (role === "host" && !applying)
    socket.emit("pause", video.currentTime);
};
video.onseeked = () => {
  if (role === "host" && !applying)
    socket.emit("seek", video.currentTime);
};

/* ===== RECEIVE ===== */
socket.on("state", applyState);
</script>

</body>
</html>